apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-manager-config
  namespace: neobridge
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    
    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      
      upstream kong_admin {
        server kong-proxy:8001;
      }
      
      server {
        listen 80;
        server_name localhost;
        
        location / {
          root /usr/share/nginx/html;
          index index.html index.htm;
          try_files $uri $uri/ /index.html;
        }
        
        location /admin/ {
          proxy_pass http://kong_admin/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /status {
          proxy_pass http://kong_admin/status;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong-manager
  namespace: neobridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kong-manager
  template:
    metadata:
      labels:
        app: kong-manager
    spec:
      containers:
      - name: kong-manager
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: kong-manager-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: kong-manager-html
          mountPath: /usr/share/nginx/html
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: kong-manager-config
        configMap:
          name: kong-manager-config
      - name: kong-manager-html
        emptyDir: {}
      initContainers:
      - name: kong-manager-setup
        image: nginx:alpine
        command: ['/bin/sh', '-c']
        args:
        - |
          cat > /tmp/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NeoBridge Kong Manager</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: rgba(255, 255, 255, 0.1);
                      padding: 30px;
                      border-radius: 15px;
                      backdrop-filter: blur(10px);
                      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                  }
                  h1 {
                      text-align: center;
                      margin-bottom: 30px;
                      font-size: 2.5em;
                      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                  }
                  .services-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  .service-card {
                      background: rgba(255, 255, 255, 0.2);
                      padding: 20px;
                      border-radius: 10px;
                      border: 1px solid rgba(255, 255, 255, 0.3);
                      transition: transform 0.3s ease, box-shadow 0.3s ease;
                  }
                  .service-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                  }
                  .service-card h3 {
                      margin-top: 0;
                      color: #ffd700;
                      font-size: 1.3em;
                  }
                  .service-card p {
                      margin: 10px 0;
                      line-height: 1.6;
                  }
                  .service-card a {
                      color: #87ceeb;
                      text-decoration: none;
                      font-weight: bold;
                  }
                  .service-card a:hover {
                      text-decoration: underline;
                  }
                  .status-indicator {
                      display: inline-block;
                      width: 12px;
                      height: 12px;
                      border-radius: 50%;
                      margin-right: 8px;
                      background-color: #4CAF50;
                      animation: pulse 2s infinite;
                  }
                  @keyframes pulse {
                      0% { opacity: 1; }
                      50% { opacity: 0.7; }
                      100% { opacity: 1; }
                  }
                  .admin-section {
                      background: rgba(255, 255, 255, 0.15);
                      padding: 20px;
                      border-radius: 10px;
                      margin-top: 20px;
                      text-align: center;
                  }
                  .admin-section h2 {
                      color: #ffd700;
                      margin-top: 0;
                  }
                  .admin-section a {
                      display: inline-block;
                      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
                      color: white;
                      padding: 12px 24px;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      transition: transform 0.3s ease;
                      margin: 10px;
                  }
                  .admin-section a:hover {
                      transform: scale(1.05);
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      padding-top: 20px;
                      border-top: 1px solid rgba(255, 255, 255, 0.3);
                      font-size: 0.9em;
                      opacity: 0.8;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸš€ NeoBridge Kong Manager</h1>
                  
                  <div class="services-grid">
                      <div class="service-card">
                          <h3><span class="status-indicator"></span>Kong API Gateway</h3>
                          <p><strong>Status:</strong> Running</p>
                          <p><strong>External IP:</strong> 34.65.90.187</p>
                          <p><strong>Purpose:</strong> Main API gateway and load balancer</p>
                          <a href="http://34.65.90.187:8001/status" target="_blank">Check Status</a>
                      </div>
                      
                      <div class="service-card">
                          <h3><span class="status-indicator"></span>Test Service</h3>
                          <p><strong>Status:</strong> Running</p>
                          <p><strong>Purpose:</strong> Validation service for testing</p>
                          <a href="http://34.65.90.187/" target="_blank">Access Service</a>
                      </div>
                      
                      <div class="service-card">
                          <h3><span class="status-indicator"></span>Prometheus</h3>
                          <p><strong>Status:</strong> Running</p>
                          <p><strong>Purpose:</strong> Metrics collection and monitoring</p>
                          <p><strong>Port:</strong> 9090 (Internal)</p>
                      </div>
                      
                      <div class="service-card">
                          <h3><span class="status-indicator"></span>Grafana</h3>
                          <p><strong>Status:</strong> Running</p>
                          <p><strong>External IP:</strong> 34.65.237.186:3000</p>
                          <p><strong>Purpose:</strong> Monitoring dashboards</p>
                          <a href="http://34.65.237.186:3000" target="_blank">Open Dashboard</a>
                      </div>
                      
                      <div class="service-card">
                          <h3><span class="status-indicator"></span>Alertmanager</h3>
                          <p><strong>Status:</strong> Running</p>
                          <p><strong>Purpose:</strong> Alert routing and notification</p>
                          <p><strong>Port:</strong> 9093 (Internal)</p>
                      </div>
                  </div>
                  
                  <div class="admin-section">
                      <h2>ðŸ”§ Kong Administration</h2>
                      <p>Manage your Kong API Gateway configuration and monitor services</p>
                      <a href="http://34.65.90.187:8001" target="_blank">Kong Admin API</a>
                      <a href="http://34.65.90.187:8001/status" target="_blank">Kong Status</a>
                  </div>
                  
                  <div class="footer">
                      <p>NeoBridge Platform - Deployed on Google Cloud Platform (Switzerland)</p>
                      <p>Deployment Status: 100% Complete âœ… | Location: europe-west6-a ðŸ‡¨ðŸ‡­</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          cp /tmp/index.html /kong-manager-html/
        volumeMounts:
        - name: kong-manager-html
          mountPath: /kong-manager-html
---
apiVersion: v1
kind: Service
metadata:
  name: kong-manager
  namespace: neobridge
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  selector:
    app: kong-manager
